---
layout: post
category: docker
title: è§†é¢‘ç¬”è®°ï¼šå®¹å™¨æ˜¯å¦‚ä½•ç‚¼æˆçš„ï¼Ÿ - JÃ©rÃ´me Petazzoni
date: 2017-01-30
tags: [docker, dockercon15-eu, youtube, notes]
---

<!-- toc -->

# è§†é¢‘ä¿¡æ¯

Cgroups, namespaces and beyond: what are containers made from?
by JÃ©rÃ´me Petazzoni (@jpetazzo)
at DockerCon EU 2015

{% owl youtube sK5i-N34im8 %}

<https://www.youtube.com/watch?v=sK5i-N34im8>

å¹»ç¯åœ°å€ï¼š<http://www.slideshare.net/Docker/cgroups-namespaces-and-beyond-what-are-containers-made-from>

# è‡ªæˆ‘ä»‹ç»

JÃ©rÃ´me Petazzoni ([@jpetazzo](https://github.com/jpetazzo))ï¼Œæ˜¯æ³•å›½è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œç°åœ¨ä½åœ¨åŠ å·ã€‚ä»–æ˜¯ [dotCloud](https://en.wikipedia.org/wiki/DotCloud) çš„è€å‘˜å·¥äº†ï¼Œæ„å»ºäº†å…¶ PaaS å¹³å°ï¼Œä¹Ÿå°±æ˜¯è¯´æ—©åœ¨ Docker æˆä¸º Docker ä¹‹å‰ï¼Œä»–å°±å·²ç»åœ¨ä¸º Docker å†™ä»£ç äº†ã€‚éƒ½å¿« 5 å¹´äº†ã€‚

éå¸¸å–œæ¬¢å®£è®²å®¹å™¨çš„å¥½å¤„ï¼Œç¬¬ä¸€æ¬¡ä¼°è®¡æ˜¯ 2013 å¹´ 2 æœˆåœ¨æ´›æ‰çŸ¶çš„ SCALE å¤§ä¼šä¸Šçš„è®²åº§ã€‚

éå¸¸è‡ªè±ªè‡ªå·±æ˜¯ Bash å ‚çš„æˆå‘˜ã€‚ï¼ˆå°±æ˜¯è¯´å¦‚æœè§‰å¾—å¤ªçƒ¦äº†ï¼Œå°±ä¼šæŠŠæŸäº›ä»£ç æ¢æˆä¸€æ®µè„šæœ¬æ¥å®ç°â€¦â€¦ğŸ˜¹ï¼‰

# å¤§çº²

è¿™æ¬¡è®²åº§æ˜¯æ»¡æ»¡çš„å¹²è´§ï¼š

* ä»ä¸Šå±‚å’Œåº•å±‚åˆ†åˆ«è®²è§£åˆ°åº•ä»€ä¹ˆæ˜¯å®¹å™¨ã€‚
* è®²è§£å®¹å™¨çš„åŸºçŸ³ï¼š`namespaces`, `cgroups`, `copy-on-write storage`
* å„ç§å®¹å™¨è¿è¡Œæ—¶ï¼š`Docker`, `LXC`, `rkt`, `runC`, `systemd-nspawn`, `OpenVZ`, `Jails`, `Zones`
* æœ€åç°åœºç”¨çº¯æ‰‹å·¥æ¥åˆ¶ä½œä¸€ä¸ªå®¹å™¨ğŸ‘

# ä»€ä¹ˆæ˜¯å®¹å™¨ï¼Ÿ

## ä»ä¸Šå±‚è§†è§’å»çœ‹ï¼šå®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§è™šæ‹Ÿæœº

æœ€åˆä»‹ç»å®¹å™¨çš„æ—¶å€™ï¼Œæ€»ä¼šç”¨è¿™æ ·çš„è¯´æ³•ï¼Œâ€å—¯ï¼Œå®¹å™¨å˜›ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½»é‡çº§è™šæ‹Ÿæœºâ€ï¼Œè€Œå®é™…è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å´åˆç»å¸¸è¯´"Docker ä¸æ˜¯è™šæ‹Ÿæœºï¼Œä¸è¦åœ¨è¿™ä¹ˆç†è§£ Dockerâ€œã€‚

ä¸ºä»€ä¹ˆå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿå› ä¸ºå¦‚æœç”¨æˆ·å•¥éƒ½ä¸æ‡‚çš„æ—¶å€™ï¼Œç”¨æˆ·ä»è¡¨é¢ä¸Šä¼šè§‰å¾—å’Œè™šæ‹Ÿæœºæ¥è¿‘ï¼š

* ç”¨æˆ·å¯ä»¥å–å¾—ä¸€ä¸ª Shellï¼Œè¾“å…¥å‘½ä»¤å’Œè¿”å›ç»“æœ
* ç”¨èµ·æ¥æ„Ÿè§‰ä¸Š**åƒæ˜¯**è™šæ‹Ÿæœº
	* æœ‰è‡ªå·±çš„è¿›ç¨‹ç©ºé—´
		* è¿è¡Œ `ps` çš„æ—¶å€™åªèƒ½çœ‹åˆ°å®¹å™¨å†…çš„è¿›ç¨‹
	* æœ‰è‡ªå·±çš„ç½‘ç»œæ¥å£
		* `ip addr`, `ifconfig` æ—¶å¯ä»¥çœ‹åˆ°è‡ªå·±ç‹¬ç«‹çš„ç½‘ç»œæ¥å£
	* è¿˜å¯ä»¥ä»¥ `root` èº«ä»½è¿è¡Œä¸œè¥¿
	* ç”šè‡³è¿˜å¯ä»¥ç”¨ `apt`/`yum` æ¥å®‰è£…è½¯ä»¶
	* è¿˜å¯ä»¥å¯åŠ¨æœåŠ¡
	* è¿˜å¯ä»¥éšæ„çš„é¼“æ£è·¯ç”±è¡¨ã€`iptables`â€¦â€¦


## ä½†æ˜¯ä»åº•å±‚å»çœ‹ï¼šå®ƒæ˜¯ä¸€ä¸ªç©å—¨äº†çš„ `chroot`

å®ƒå¹¶ä¸åƒè™šæ‹Ÿæœºï¼Œå› ä¸ºï¼š

* å®ƒç”¨çš„æ˜¯å®¿ä¸»çš„å†…æ ¸
* å®ƒä¸èƒ½å¯åŠ¨åˆ°åˆ«çš„ç³»ç»Ÿï¼ˆæ¯”å¦‚å®¹å™¨é‡Œè·‘ä¸ª FreeBSD)
* å®ƒä¸èƒ½åŠ è½½è‡ªå·±å†…æ ¸æ¨¡å—
* ç”šè‡³ä¸éœ€è¦ä½œä¸º `PID` ä¸º `1` çš„ `init`
* è€Œä¸”é‡Œé¢æ ¹æœ¬ä¸è·‘ `syslogd`, `cron` ç­‰ç­‰ç³»ç»ŸæœåŠ¡

æ‰€ä»¥å®¹å™¨åªæ˜¯ä¸€å †è¿›ç¨‹ï¼Œå¯ä»¥ç›´æ¥åœ¨å®¿ä¸» `ps` çœ‹åˆ°æ‰€æœ‰å®¹å™¨çš„è¿›ç¨‹ã€‚è¿™ç‚¹å’Œè™šæ‹Ÿæœºå®Œå…¨ä¸åŒï¼Œè™šæ‹Ÿæœºæ˜¯ä¸é€æ˜çš„ã€‚

è€Œè¿™äº›å®¹å™¨å†…çš„è¿›ç¨‹åªå¯ä»¥çœ‹åˆ°è‡ªå·±çš„ç©ºé—´å†…çš„ä¸œè¥¿ï¼Œè€Œçœ‹ä¸åˆ°å…¶å®ƒå®¹å™¨æˆ–è€…å®¿ä¸»ç©ºé—´å†…çš„ä¸œè¥¿ã€‚æ‰€ä»¥å®ƒä»¬ç”Ÿæ´»åœ¨è‡ªå·±çš„ä¸–ç•Œé‡Œï¼Œå¯ä»¥æ‹¥æœ‰è‡ªå·±çš„æ“ä½œç³»ç»Ÿï¼ˆå½“ç„¶æŒ‡Linuxä¸åŒçš„å‘è¡Œç‰ˆæœ¬ï¼‰ã€‚

# é‚£å®¹å™¨æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ

5å¹´å‰ JÃ©rÃ´me åŠ å…¥ dotCloud çš„æ—¶å€™ï¼Œæƒ³ç†è§£ä¸€ä¸‹å•¥æ˜¯å®¹å™¨ï¼Œäºæ˜¯æ¥çœ‹ Linux å†…æ ¸æºä»£ç å§ï¼

å—¯ï¼Œèµ¶ç´§è·‘åˆ° [LXR](http://lxr.free-electrons.com/) å»æŸ¥é˜… Linux ä»£ç 

ç»“æœå‘ç°ï¼Œæœç´¢ `LXC`ï¼Œä¸€æ¡è®°å½•éƒ½æ²¡æœ‰ **(âŠ™ï¹âŠ™)b**ï¼›å†å»æœç´¢ `container`ï¼Œå—¯ï¼Œè¿™æ¬¡å€’æ˜¯æœ‰äº†ä¸€åƒå¤šæ¡ç»“æœï¼Œä¸è¿‡ä»”ç»†ä¸€çœ‹ï¼Œéƒ½æ˜¯ä¸€å¸®å­æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚ `ACPI containers` ä¹‹ç±»çš„ï¼Œè¿™æ˜¯ä»€ä¹ˆğŸ‘»ï¼Ÿå®Œå…¨è·Ÿæˆ‘ä»¬è¯´çš„å®¹å™¨æ²¡å…³ç³»å˜›ã€‚

å€’æ˜¯æœ‰äº›æ–‡æ¡£é‡Œæˆ–éšæˆ–ç°çš„æåˆ°äº†ä¸€äº›å…³äºæˆ‘ä»¬æ‰€è¯´çš„å®¹å™¨ï¼Œä¸è¿‡é‚£æ˜¯æ–‡æ¡£ï¼Œä¸æ˜¯ä»£ç å•Šã€‚

å¥½å§ï¼Œé‚£æ˜¯å¿ƒé‡Œä¸å¾—ä¸é—®ä¸€å¥ï¼Œå®¹å™¨è¿™é¬¼éš¾é“ä¸åœ¨å†…æ ¸é‡Œï¼Ÿä¹‹å‰å¬åˆ°å®¹å™¨ç”¨çš„æ˜¯å†…æ ¸æŠ€æœ¯éƒ½æ˜¯éª—äººçš„ä¸æˆï¼Ÿç”šè‡³â€¦â€¦*å®¹å™¨*ä¸ä¼šå‹æ ¹å°±ä¸å­˜åœ¨å§ï¼Ÿ

ç»è¿‡ä¸€ç•ªç ”ç©¶ï¼Œææ˜ç™½äº†*å®¹å™¨*ä¸åœ¨å†…æ ¸é‡Œï¼Œåœ¨å†…æ ¸é‡Œçš„æ˜¯å®ç°å®¹å™¨çš„ã€è‘—åçš„ `cgroups` å’Œ `namespaces`ã€‚

# å®¹å™¨åŸºçŸ³ - 1ï¼š`Control Groups`

## ä»€ä¹ˆæ˜¯ `Control Groups`ï¼Ÿ

`Control Groups`ï¼Œå—æ§ç»„ï¼Œä¹Ÿç§°ä¸º `cgroups`ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯æ§åˆ¶ç‹‚ï¼Œå®ƒçš„ç›®çš„æ˜¯å¯¹ä¸€åˆ‡è¿›è¡Œé™åˆ¶ã€‚æ¯”å¦‚ï¼š

* å¯¹èµ„æºä½¿ç”¨çš„æµ‹é‡å’Œé™åˆ¶ï¼ŒåŒ…æ‹¬å†…å­˜ã€CPUã€å—è®¾å¤‡ I/Oã€ç½‘ç»œç­‰
* å¯¹è®¾å¤‡ï¼ˆ`/dev/*`ï¼‰çš„è®¿é—®æ§åˆ¶
* æ‹¥å¡æ§åˆ¶

## æ¦‚è®º

* æ¯ä¸ªå­ç³»ç»Ÿï¼ˆå†…å­˜ã€CPUç­‰ï¼‰éƒ½æœ‰ä¸€ä¸ªæ ‘å½¢çš„å±‚çº§ç»“æ„
* å±‚çº§ç»“æ„é—´æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ç›¸ä¸å½±å“ã€‚å› æ­¤å†…å­˜å’ŒCPUå¯ä»¥æ˜¯ä¸åŒçš„å±‚çº§ç»“æ„
* æ¯ä¸€ä¸ªè¿›ç¨‹åœ¨æ¯ä¸€ä¸ªæ ‘å½¢å±‚çº§ç»“æ„ä¸­åªå¯ä»¥å±äºä¸€ä¸ªèŠ‚ç‚¹
* æ¯ä¸€ä¸ªæ ‘å½¢å±‚çº§ç»“æ„éƒ½èµ·å§‹äºä¸€ä¸ªèµ·ç‚¹ï¼ˆ`root`ï¼‰
* æ‰€æœ‰çš„è¿›ç¨‹æœ€åˆéƒ½æ˜¯å±äºæ¯ä¸ªå±‚çº§ç»“æ„çš„æ ¹(`root`) èŠ‚ç‚¹
* æ¯ä¸€ä¸ªèŠ‚ç‚¹é‡Œæ˜¯ä¸€ç»„è¿›ç¨‹

å› æ­¤å³ä½¿ä½ æ²¡æœ‰ä½¿ç”¨ Dockerï¼Œä½ çš„æ‰€æœ‰è¿›ç¨‹ä¾æ—§æ˜¯åœ¨å®¹å™¨é‡Œè¿è¡Œçš„ï¼Œå› ä¸ºä»–ä»¬éƒ½å±äºå„ä¸ª cgroups é‡Œçš„æ ¹èŠ‚ç‚¹ã€‚æ•´ä¸ªæœºå™¨å°±æ˜¯ä¸€ä¸ªå¤§çš„å®¹å™¨ã€‚æ‰€ä»¥å¦‚æœä½ è¦æ˜¯è§‰å¾—ä½ çš„è¿›ç¨‹ä¸åœ¨å®¹å™¨é‡Œå°±ä¼šæ›´å¿«äº›ï¼Œè¿™æ˜¯ç»å¯¹ä¸å¯èƒ½çš„ï¼Œæ— è®ºç”¨ä¸ç”¨ dockerï¼Œæ— è®ºæ˜¯å®¹å™¨å†…è¿›ç¨‹è¿˜æ˜¯å®¿ä¸»è¿›ç¨‹ï¼Œéƒ½ä¸€æ ·çš„ä½äºå®¹å™¨å†…ã€‚

æ¯”å¦‚ï¼Œä¸‹é¢è¿™ä¸ªæ˜¯ CPU çš„æ ‘å½¢å±‚çº§ç»“æ„ï¼Œæœ€ç»ˆçš„æ•°å­—æ˜¯ `PID`ï¼š

```bash
cpu
â”œâ”€â”€ batch
â”‚Â Â  â”œâ”€â”€ bitcoins
â”‚Â Â  â”‚Â Â  â””â”€â”€ 52
â”‚Â Â  â””â”€â”€ hadoop
â”‚Â Â      â”œâ”€â”€ 109
â”‚Â Â      â””â”€â”€ 88
â””â”€â”€ realtime
    â”œâ”€â”€ nginx
    â”‚Â Â  â”œâ”€â”€ 25
    â”‚Â Â  â”œâ”€â”€ 26
    â”‚Â Â  â””â”€â”€ 27
    â”œâ”€â”€ postgres
    â”‚Â Â  â””â”€â”€ 524
    â””â”€â”€ redis
        â””â”€â”€ 1008
```

è€Œä¸‹é¢è¿™ä¸ªåˆ™æ˜¯å†…å­˜çš„æ ‘å½¢å±‚çº§ç»“æ„ï¼Œå¯ä»¥çœ‹åˆ°è¿˜æ˜¯è¿™ä¸€æ‰¹è¿›ç¨‹ï¼Œä½†æ˜¯å’ŒCPU çš„å±‚çº§ç»“æ„å®Œå…¨ä¸åŒï¼š

```bash
memory
â”œâ”€â”€ 109
â”œâ”€â”€ 25
â”œâ”€â”€ 26
â”œâ”€â”€ 27
â”œâ”€â”€ 52
â”œâ”€â”€ 88
â””â”€â”€ databases
    â”œâ”€â”€ 1008
    â””â”€â”€ 524
```

## å†…å­˜ `cgroup`ï¼šè®°è´¦

è®°å½•æ¯ä¸€ç»„è¿›ç¨‹ä½¿ç”¨çš„å†…å­˜é¡µï¼ˆæ§åˆ¶çš„ç»†ç²’åº¦æ˜¯*é¡µ*ï¼‰ï¼š

* æ–‡ä»¶ï¼ˆä»å—è®¾å¤‡çš„è¯»ã€å†™ã€æ˜ å°„ï¼‰
* åŒ¿åï¼ˆæ ˆã€å †ã€åŒ¿åæ˜ å°„ï¼‰
* æ´»è·ƒï¼ˆæœ€è¿‘è®¿é—®è¿‡çš„ï¼‰
* ä¸æ´»è·ƒï¼ˆå°†è¢«æ¸…ç†çš„ï¼‰

æ¯ä¸€å†…å­˜é¡µéƒ½è¢«è®°åˆ°ä¸€ä¸ª**ç»„**çš„è´¦ä¸Šã€‚å†…å­˜é¡µå¯ä»¥è·¨å¤šç»„å…±äº«ï¼Œæ¯”å¦‚å¤šä¸ªè¿›ç¨‹ä»ä¸€ç»„ç›¸åŒçš„æ–‡ä»¶ä¸­è¯»å–ä¿¡æ¯ã€‚å½“é¡µè¢«å…±äº«çš„æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªç»„ä¼šä¸ºæ­¤ä¹°å•ã€‚

## å†…å­˜ `cgroup`ï¼šé™åˆ¶

æ¯ä¸€ä¸ªç»„éƒ½å¯ä»¥æœ‰ `hard` å’Œ `soft` çš„é™åˆ¶ã€‚

* `soft` é™åˆ¶å¹¶ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œå®ƒåœ¨å†…å­˜å‹åŠ›ä¸‹å¯ä»¥å½±å“å›æ”¶èµ„æºã€‚
*  `hard` åˆ™æ˜¯å¼ºåˆ¶çš„ï¼Œç›´æ¥ä¼šè§¦å‘è¯¥ç»„çš„ `OOM killer`

`OOM Killer` å¯ä»¥å®šåˆ¶å…¶è¡Œä¸ºã€‚

* æ¯”å¦‚ï¼Œå½“ `hard limit` è¶…äº†çš„æ—¶å€™ï¼Œå†»ç»“ç»„å†…æ‰€æœ‰è¿›ç¨‹ï¼Œé€šçŸ¥ç”¨æˆ·ç©ºé—´ï¼ˆè€Œä¸æ˜¯ `rampage`ï¼‰ï¼Œç„¶åå¯ä»¥æ€äº†è¿›ç¨‹ã€æå‡ `limit`ã€ç„¶ååœ¨è¿è¡Œæ–°çš„å®¹å™¨ï¼Œå½“ä¸€åˆ‡éƒ½å¥½äº†çš„æ—¶å€™ï¼Œåœ¨è§£å†»è¯¥ç»„ã€‚

é™åˆ¶å¯ä»¥è®¾ç½®äºç‰©ç†å†…å­˜ã€å†…æ ¸å†…å­˜æˆ–æ€»å…±å†…å­˜ã€‚

## å†…å­˜ `cgroup`ï¼šä¸€äº›éœ€è¦æ³¨æ„çš„ç»†èŠ‚

æ¯æ¬¡å†…æ ¸ç»™è¿›ç¨‹ä¸€ä¸ªé¡µé¢ï¼Œæˆ–è€…æ’¤èµ°ä¸€ä¸ªé¡µé¢ï¼Œå®ƒéƒ½ä¼šæ›´æ–°è®¡æ•°å™¨ã€‚è¿™ä¼šå¢åŠ ä¸€äº›é¢å¤–å¼€é”€ï¼Œè€Œä¸”è¿™æ— æ³•é’ˆå¯¹ç‰¹å®šè¿›ç¨‹å…³é—­ï¼Œåªå¯ä»¥å¼•å¯¼å‚æ•°ä¸Šè®¾ç½®ã€‚

ä¹‹å‰è¯´è¿‡ï¼Œå¦‚æœå¤šç»„ä½¿ç”¨ç›¸åŒçš„é¡µçš„æ—¶å€™ï¼Œåªæœ‰ä¸€ä¸ªç»„ä¼šä¹°å•ã€‚ä¸è¿‡å¦‚æœè¿™ä¸ªç»„åœæ­¢ä½¿ç”¨è¿™ä¸ªé¡µäº†ï¼Œé‚£ä¹ˆè´¦å•ä¼šè·‘åˆ°å¦ä¸€ä¸ªä½¿ç”¨å®ƒçš„ç»„ä¸Šã€‚

## `HugeTLB cgroup`

è¿™æ˜¯ç”¨æ¥æ§åˆ¶ä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨çš„ `huge pages` çš„æ•°é‡ã€‚å¦‚æœä½ ä¸çŸ¥é“è¿™æ˜¯å•¥çš„è¯ï¼Œå¯ä»¥è·³è¿‡å»ï¼Œæ²¡é—®é¢˜ã€‚

## `CPU cgroup`

* è®°å½•ç”¨æˆ·/ç³»ç»Ÿçš„ CPU æ—¶é—´
* è®°å½•æ¯ CPU çš„ä½¿ç”¨æƒ…å†µ
* å…è®¸è®¾ç½®æƒé‡
* æ— æ³•è®¾ç½® CPU é™åˆ¶

## `cpuset cgroup`

* å¯ä»¥å°†ç»„å›ºå®šåœ¨ç‰¹å®šçš„ CPU ä¸Š
* å¯ä»¥ä¿ç•™ CPU ç»™ç‰¹å®šçš„ app
* å¯ä»¥é¿å…è¿›ç¨‹æ¥å›åœ¨ä¸åŒçš„ CPU ä¸Šè·³æ¥è·³å»
* è¿™ä¹Ÿå’Œ NUMA ç³»ç»Ÿç›¸å…³
* æä¾›é¢å¤–çš„è°ƒèŠ‚èƒ½åŠ›ï¼ˆæ¯åŒºåŸŸå†…å­˜å‹åŠ›ã€è¿›ç¨‹è¿ç§»å¼€é”€â€¦â€¦ï¼‰

## `blkio cgroup`

* è®°å½•æ¯ç»„çš„ I/O æ•°ç›®
	* æ¯ä¸ªå—è®¾å¤‡
	* è¯»ã€å†™
	* åŒæ­¥ã€å¼‚æ­¥

* å¯¹æ¯ä¸ªç»„è®¾ç½®ååé‡é™åˆ¶
	* æ¯ä¸ªå—è®¾å¤‡
	* è¯»ã€å†™
	* ops æˆ–è€… bytes

* å¯¹æ¯ä¸ªç»„è®¾ç½®ç›¸å¯¹æƒé‡

**éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¤§éƒ¨åˆ†å†™æ“ä½œéƒ½æ˜¯å†™åˆ°ç¼“å­˜çš„ï¼Œå› æ­¤æ™®é€šçš„å†™æ“ä½œæœ€åˆä¼šçœ‹èµ·æ¥åƒæ²¡æœ‰è¢«é™åˆ¶ååé‡ä¸€æ ·ã€‚**

## `net_cls` å’Œ `net_prio` `cgroup`

* è‡ªåŠ¨ä¸ºç»„ä¸­è¿›ç¨‹äº§ç”Ÿçš„ç½‘ç»œæµé‡è®¾ç½®åˆ†ç±»å’Œä¼˜å…ˆçº§ï¼›
* åªå¯¹å¤–å‡ºæµé‡æœ‰æ•ˆ
* `net_cls` å°†ç”¨äºæŒ‡å®šæµé‡ä¸€ä¸ªåˆ†ç±»
	* å½“ç„¶ï¼Œè¿™ä¸ªåˆ†ç±»éœ€è¦åœ¨ `tc`/`iptables` æ¥åŒ¹é…ä»è€Œè¿›è¡Œæ§åˆ¶ï¼Œå¦åˆ™ä¼šå’Œæ™®é€šæµé‡ä¸€æ ·ã€‚
* `net_prio` ä¼šæŒ‡å®šæµé‡çš„ä¼˜å…ˆçº§
	* é˜Ÿåˆ—æœºåˆ¶å°†ä¼šä½¿ç”¨è¿™ä¸ªä¼˜å…ˆçº§è¿›è¡Œå¤„ç†

## è®¾å¤‡ `cgroup`

æ§åˆ¶ä¸€ä¸ªç»„å¯ä»¥å¯¹ä¸€ä¸ªè®¾å¤‡èŠ‚ç‚¹åšäº›ä»€ä¹ˆã€‚æ¯”å¦‚ï¼Œè¯»ã€å†™ã€`mknod` ç­‰

å…¸å‹çš„ç”¨æ³•æœ‰ï¼š

* å…è®¸ `/dev/{tty,zero,random,null}`...
* æ‹’ç»æ‰€æœ‰å…¶å®ƒçš„ã€‚

ä¸€äº›æ¯”è¾ƒæœ‰è¶£çš„è®¾å¤‡èŠ‚ç‚¹ï¼š

* `/dev/net/tun`ï¼š ç½‘ç»œç•Œé¢ç»´æŠ¤
* `/dev/fuse`ï¼š ç”¨æˆ·ç©ºé—´çš„æ–‡ä»¶ç³»ç»Ÿ
* `/dev/kvm`ï¼šå®¹å™¨å†…çš„è™šæ‹Ÿæœºï¼Ÿï¼ğŸ˜‚OMG, è™šæ‹ŸåŒ–ç‰ˆç›—æ¢¦ç©ºé—´ï¼Ÿ
* `/dev/dri`ï¼šGPU

## `freezer cgroup`

å…è®¸å†»ç»“å’Œå”¤é†’ä¸€ç»„è¿›ç¨‹ã€‚åŠŸèƒ½ä¸Šç›¸ä¼¼äº `SIGSTOP/SIGCONT`ï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯è¿›ç¨‹æ— æ³•æ„ŸçŸ¥åˆ°è¿™ä¸ªçŠ¶æ€å˜åŒ–ï¼Œè€Œ `SIGSTOP/SIGCONT` æ˜¯è¿›ç¨‹å¯ä»¥å¤„ç†çš„ä¿¡å·ã€‚è€Œä¸”å¹¶ä¸ä¼šå¦¨ç¢ `ptrace` è°ƒè¯•ã€‚

ç‰¹æ®Šç”¨æ³•ï¼š

* é›†ç¾¤æˆæ‰¹è°ƒåº¦
* è¿›ç¨‹è¿ç§»

## ä¸€äº›æ³¨æ„äº‹é¡¹

* æ¯ä¸€ä¸ªå±‚çº§å…³ç³»çš„æ ¹èŠ‚ç‚¹éƒ½æ˜¯ `PID 1` çš„è¿›ç¨‹
* æ–°å¯åŠ¨çš„è¿›ç¨‹å°†å±äºå®ƒä»¬çš„çˆ¶è¿›ç¨‹æ‰€åœ¨çš„ç»„
* ç»„å°†å…·åŒ–ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªä¼ªæ–‡ä»¶ç³»ç»Ÿ
	* ä¸€èˆ¬ä½äº `/sys/fs/cgroup` ä¸‹
* åˆ›å»ºç»„çš„åŠæ³•å°±æ˜¯åœ¨é‚£äº›ä¼ªæ–‡ä»¶ç³»ç»Ÿä¸­ç”¨ `mkdir` åˆ›å»ºç›®å½•
* è¦ç§»åŠ¨ä¸€ä¸ªè¿›ç¨‹åˆ°ä¸€ä¸ªç»„åªéœ€è¦ï¼š
	* `echo $PID > /sys/fs/cgroup/.../tasks`
* `cgroup` çš„æˆ˜äº‰ï¼š`systemd` vs `cgmanager` vs ...

# å®¹å™¨åŸºçŸ³ - 2ï¼š`namespaces`

* ä¸ºè¿›ç¨‹æä¾›è‡ªå·±çš„ç³»ç»Ÿè§†è§’
* `cgroups` é™åˆ¶ä½ ç”¨å¤šå°‘ï¼›`namespaces` é™åˆ¶ä½ èƒ½çœ‹åˆ°ä»€ä¹ˆã€‚
* æœ‰å¤šç§ `namespaces`ï¼š
	* `pid`
	* `net`
	* `mnt`
	* `uts`
	* `ipc`
	* `user`
* å¯¹äºæŸç±» `namespace` è€Œè¨€ï¼Œæ¯ä¸ªè¿›ç¨‹å±äºä¸€ä¸ª `namespace`ã€‚

## `pid namespace`

* ä¸€ä¸ª `pid namespace` çš„è¿›ç¨‹åªèƒ½çœ‹åˆ°åœ¨åŒ `pid namespace` çš„å…¶å®ƒè¿›ç¨‹
* æ¯ä¸ª `pid namespace` éƒ½æœ‰è‡ªå·±çš„ `pid` ç¼–å·ï¼Œä» `1` å¼€å§‹
* å½“ `pid 1` æŒ‚äº†ï¼Œæ•´ä¸ª `namespace` éƒ½ä¼šè¢«å¹²æ‰
* `namespace` å¯ä»¥åµŒå¥—
* å› æ­¤ä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¼šæœ‰å¤šä¸ª `PID`ï¼Œæ¯ä¸ª `namespace` ä¸€ä¸ª `pid`

## `net namespace`

### ç†è®ºä¸Š

åœ¨ä¸€ä¸ªç»™å®šç½‘ç»œå‘½åç©ºé—´ä¸­çš„è¿›ç¨‹ä¼šæ‹¥æœ‰è‡ªå·±çš„ç§æœ‰ç½‘ç»œæ ˆï¼ŒåŒ…æ‹¬ï¼š

* ç½‘ç»œæ¥å£ï¼ˆåŒ…æ‹¬æœ¬åœ°å›ç¯ï¼‰
* è·¯ç”±è¡¨
* iptables è§„åˆ™
* sockets (ss, netstat)

ä½ å¯ä»¥ä»ä¸€ä¸ª `netns` ç§»åŠ¨ä¸€ä¸ªç½‘ç»œæ¥å£åˆ°å¦ä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´

```bash
ip link set dev eth0 netns PID
```

### å®é™…ä¸Š

å…¸å‹çš„ä½¿ç”¨æ–¹å¼ï¼š

* ä½¿ç”¨ `veth` å¯¹ï¼ˆä¸¤ä¸ªè™šæ‹Ÿæ¥å£åƒä½¿ç”¨äº¤å‰çº¿è¿æ¥ä¸€æ ·ï¼‰
* å®¹å™¨ç½‘ç»œå‘½åç©ºé—´çš„ `eth0` å’Œå®¿ä¸»ç½‘ç»œå‘½åç©ºé—´çš„ `vethXXX` é…å¯¹
* å¹¶ä¸”æ‰€æœ‰çš„ `vethXXX` éƒ½æ¡¥æ¥åœ¨ä¸€èµ·ï¼ˆåœ¨Dockerä¸­è¿™ä¸ªæ¡¥æ¥å¦‚æœæ˜¯é»˜è®¤æ¡¥æ¥å°±æ˜¯ docker0ï¼‰

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ä½¿ç”¨ `--net container:å®¹å™¨` çš„ä½¿ç”¨æ–¹å¼ï¼Œå¯ä»¥å…±äº«ç½‘ç»œæ ˆã€‚

## `mnt namespace`

* è¿›ç¨‹å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„ `rootfs`ï¼ˆå°±åƒ `chroot` ä¸€æ ·ï¼‰
* è¿›ç¨‹è¿˜å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„ *ç§æœ‰* çš„æŒ‚è½½
	* `/tmp` ï¼ˆæ¯ç”¨æˆ·ã€æ¯æœåŠ¡ï¼‰
	* `/proc` å’Œ `/sys` çš„ masking
	* NFS è‡ªåŠ¨æŒ‚è½½ä¹‹ç±»çš„
* æŒ‚è½½å¯ä»¥æ˜¯å®Œå…¨ç§æœ‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å…±äº«çš„
* æ²¡æœ‰ç®€å•çš„åŠæ³•å¯ä»¥å°†ä¸€ä¸ªæŒ‚è½½è½¬ç§»åˆ°å¦ä¸€ä¸ªå‘½åç©ºé—´

## `uts namespace`

* `gethostname` / `sethostname`

## `ipc namespace`

* æœ‰äººçŸ¥é“ä»€ä¹ˆæ˜¯ `IPC` ä¹ˆï¼Ÿ
* æœ‰äººå…³å¿ƒ `IPC` ä¹ˆï¼Ÿ
* è¿è¡Œè¿›ç¨‹ï¼ˆæˆ–ä¸€ç»„è¿›ç¨‹ï¼‰å¯ä»¥æ‹¥æœ‰è‡ªå·±çš„ï¼š
	* `IPC` ä¿¡å·é‡
	* `IPC` æ¶ˆæ¯é˜Ÿåˆ—
	* `IPC` å…±äº«å†…å­˜
* è€Œä¸ä¼šå’Œå…¶å®ƒçš„å‘½åç©ºé—´çš„è¿›ç¨‹å‘ç”Ÿå†²çª

## `user namespace`

* å…è®¸æ˜ å°„ `UID/GID`ï¼Œæ¯”å¦‚
	* å®¹å™¨ `C1` å†…çš„ `UID 0 â†’ 1999` å¯¹åº”åˆ°å®¿ä¸»çš„ `UID 10000 â†’ 11999`
	* å®¹å™¨ `C2` å†…çš„ `UID 0 â†’ 1999` å¯¹åº”åˆ°å®¿ä¸»çš„ `UID 12000 â†’ 13999`
* é¿å…å®¹å™¨å†…çš„é¢å¤–é…ç½®
* è¿™æ ·è¿˜å¯ä»¥è®© `UID 0 (root)` å˜æˆå®¿ä¸»ä¸€ä¸ªéç‰¹æƒçš„æ™®é€šç”¨æˆ·
* å¯ä»¥æé«˜å®‰å…¨æ€§
* **ä½†æ˜¯**ï¼šç»†èŠ‚æ˜¯é­”é¬¼â€¦â€¦

## `namespace` æ“ä½œ

* `namespace` ç”± `clone()` ç³»ç»Ÿè°ƒç”¨åˆ›å»º
* `namespace` çš„å…·ä½“è¡¨ç°ä¸ºä¼ªæ–‡ä»¶å½¢å¼ï¼š
	* `/proc/<pid>/ns`
* å½“å‘½åç©ºé—´ä¸­æœ€åä¸€ä¸ªè¿›ç¨‹é€€å‡ºæ—¶ï¼Œå‘½åç©ºé—´å³è¢«é”€æ¯ã€‚
	* ä½†æ˜¯å¯ä»¥ä¿ç•™ç»‘å®šæŒ‚è½½çš„ä¼ªæ–‡ä»¶
* å¯ä»¥ç”¨ `setns()` æ¥*è¿›å…¥*ä¸€ä¸ªå‘½åç©ºé—´
	* æ¯”å¦‚ `util-linux` ä¸­çš„ `nsenter` å‘½ä»¤ã€‚

# å®¹å™¨åŸºçŸ³ - 3ï¼š`copy-on-write`

## `copy-on-write` å­˜å‚¨

* å¯ä»¥å³æ—¶åˆ›å»ºå®¹å™¨ï¼ˆæ— éœ€å¤åˆ¶æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼‰
* å­˜å‚¨å¯ä»¥è®°å½•æœ‰å“ªäº›å†…å®¹å‘ç”Ÿäº†æ”¹åŠ¨
* æœ‰å¾ˆå¤šå¯é€‰æ‹©çš„é€”å¾„ï¼š
	* æ–‡ä»¶å±‚é¢ï¼š`AUFS`, `overlay`
	* å—å±‚é¢ï¼š`device mapper`
	* æ–‡ä»¶ç³»ç»Ÿå±‚é¢ï¼š`btrfs`, `zfs`
* æ˜¾è‘—çš„é™ä½äº†ç³»ç»Ÿå¼€é”€ä»¥åŠå¯åŠ¨æ—¶é—´

è¿™æ˜¯éå¸¸é‡è¦çš„åŸºçŸ³ä¹‹ä¸€ï¼Œè¿™é‡Œæ— æ³•å±•å¼€è®²ï¼Œå•å•è¿™ä¸ªé—®é¢˜å°±å¯ä»¥è®²ä¸€æ•´èŠ‚è¯¾ã€‚è¿›ä¸€æ­¥çš„ä¿¡æ¯å¯ä»¥çœ‹è¿™ç¯‡åšæ–‡[ã€Šæ·±å…¥ Docker å­˜å‚¨é©±åŠ¨ã€‹](http://jpetazzo.github.io/assets/2015-07-01-deep-dive-into-docker-storage-drivers.html#1)

# å…¶å®ƒç»†èŠ‚

## æ­£äº¤æ€§

* æ‰€æœ‰ä¹‹å‰æåˆ°çš„ä¸œè¥¿éƒ½æ˜¯äº’ç›¸ç‹¬ç«‹çš„
* å¦‚æœåªéœ€è¦èµ„æºéš”ç¦»ï¼Œåªè¦ç”¨å‡ ä¸ª `cgroups` å°±å¯ä»¥
* å¯ä»¥ç”¨ç½‘ç»œå‘½åç©ºé—´æ¨¡æ‹Ÿè·¯ç”±ç½‘ç»œ
* è®© debugger è¿è¡Œäºå®¹å™¨çš„å‘½åç©ºé—´ï¼Œä½†æ˜¯å´ä¸åœ¨å…¶ cgroups é‡Œï¼Œè¿™æ ·ä¸å—èµ„æºé™åˆ¶çº¦æŸ
* åœ¨ä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒä¸­è®¾ç½®ç½‘ç»œæ¥å£ï¼Œç„¶åç§»åŠ¨åˆ°å¦ä¸€ä¸ªå‘½åç©ºé—´ä¸­ã€‚
* ç­‰ç­‰

## Capabilities

* å¯ä»¥å°†  `root` / `éroot` è¿™ç§åˆ†ç±»è¿›è¡Œè¿›ä¸€æ­¥çš„ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ã€‚
* å…è®¸ä¿ç•™ `root`ï¼Œä½†æ˜¯ä¸æä¾›å±é™©çš„æ“ä½œçš„èƒ½åŠ›
* ä½†æ˜¯ `CAP_SYS_ADMIN` ä¾æ—§æ˜¯ä»€ä¹ˆèƒ½åŠ›éƒ½æœ‰ï¼Œéœ€è¦æ³¨æ„

## SELinux / AppArmor

* è®©å®¹å™¨ç¡®å®å¯ä»¥ä¸¥æ ¼çš„çº¦æŸé™åˆ¶ä½å…¶å†…çš„è¿›ç¨‹
* è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„è¯é¢˜
* å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ª Github é¡¹ç›® https://github.com/jessfraz/bane

# ä½¿ç”¨ `cgroups` å’Œ `namespaces` çš„å®¹å™¨è¿è¡Œæ—¶

## LXC

* ä¸€å¥—ç”¨æˆ·æ€çš„å·¥å…·
* ä¸€ä¸ªå®¹å™¨å°±æ˜¯ `/var/lib/lxc` ä¸‹çš„ä¸€ä¸ªç›®å½•
* ä¸€ä¸ªç®€å•çš„é…ç½®æ–‡ä»¶ + æ ¹æ–‡ä»¶ç³»ç»Ÿ
* æ—©æœŸç‰ˆæœ¬ä¸æ”¯æŒ CoW
* æ—©æœŸç‰ˆæœ¬ä¸æ”¯æŒç§»åŠ¨é•œåƒ
* éœ€è¦å¾ˆå¤æ‚çš„å‡†å¤‡å·¥ä½œ
	* å¯¹ç³»ç»Ÿç®¡ç†å‘˜(Ops) å¯èƒ½æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å¯¹äºå¼€å‘äººå‘˜(Devs) åˆ™æ¯”è¾ƒå¤æ‚ã€‚

## systemd-nspawn

* æŒ‰ç…§å…¶ manpage çš„è¯´æ³•ï¼š
	* â€œç”¨äºè°ƒè¯•ã€æµ‹è¯•å’Œæ„å»ºâ€
	* â€œå’Œ `chroot` ç›¸ä¼¼ï¼Œä½†æ˜¯æ›´å¼ºå¤§â€
	* â€œå®ç°äº†å®¹å™¨æ¥å£â€
* è²Œä¼¼æ˜¯å°†è‡ªå·±è§†ä¸ºä¸­é—´ä»¶æ¥å£
* æœ€è¿‘å¢åŠ äº†*dockeré•œåƒ*çš„æ”¯æŒï¼ˆç«Ÿç„¶ä¸æ•¢æ­£å¤§å…‰æ˜çš„æåŠ docker åå­—ï¼‰

```c
#define INDEX_HOST "index.do" /* the URL we get the data from */ "cker.io"
#define HEADER_TOKEN "X-Do" /* the HTTP header for the auth token */ "cker-Token:"
#define HEADER_REGISTRY "X-Do" /*the HTTP header for the registry */ "cker-Endpoints:"
```

## Docker Engine

* å¼•æ“ç”± REST API æ§åˆ¶
* docker æœ€åˆçš„ç‰ˆæœ¬æ˜¯ä½¿ç”¨ LXCï¼Œè€Œç°åœ¨ä½¿ç”¨è‡ªå·±çš„ `libcontainer` è¿è¡Œæ—¶ã€‚ï¼ˆè€Œ2016å¹´åº•åˆ™ä½¿ç”¨å¼€æ”¾æ ‡å‡†çš„ runC äº†ï¼‰
* ç®¡ç†å®¹å™¨ã€é•œåƒã€æ„å»ºä»¥åŠæ›´å¤šçš„ä¸œè¥¿
* ä¸€äº›äººè®¤ä¸ºå®ƒåšçš„å¤ªå¤šäº†ï¼Œåº”è¯¥å°‘è€Œç²¾ã€‚

## rkt, runC

* å›åˆ°æ›´åŸºç¡€çš„ä¸œè¥¿
* åªå…³æ³¨äºå®¹å™¨æ‰§è¡Œ
	* æ²¡æœ‰ APIã€æ²¡æœ‰é•œåƒç®¡ç†ã€æ²¡æœ‰é•œåƒæ„å»ºç­‰ç­‰
* `rkt` å’Œ `runC` å®ç°äº†ä¸åŒçš„æ ‡å‡†ï¼š
	* `rkt` å®ç°çš„æ˜¯ `appc` (App Container) æ ‡å‡†
	* `runC` å®ç°çš„æ˜¯ `OCP` (Open Container Project) æ ‡å‡†
	* `runC` æ˜¯åˆ©ç”¨äº† Docker çš„ `libcontainer`

## å“ªä¸€ä¸ªæœ€å¥½ï¼Ÿ

* é¦–å…ˆéœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œå®ƒä»¬å…¨éƒ½æ˜¯ä½¿ç”¨åŒä¸€å¥—å†…æ ¸åŠŸèƒ½ã€‚æ‰€ä»¥æ€§èƒ½ä¸Šå®ƒä»¬å®Œå…¨ä¸€æ ·ã€‚
* æ‰€ä»¥éœ€è¦è§‚å¯Ÿå…¶*åŠŸèƒ½*ã€*è®¾è®¡*ã€*ç”Ÿæ€ç³»ç»Ÿ*ã€‚

# ä½¿ç”¨å…¶å®ƒæœºåˆ¶å®ç°çš„å®¹å™¨è¿è¡Œæ—¶

## OpenVZ

* å½“ç„¶ï¼Œè¿™è¿˜æ˜¯ Linux
* æ›´å¤è€ä¸€äº›ï¼Œä½†æ˜¯æ˜¯ç»è¿‡äº†å®æˆ˜æ£€éªŒçš„
	* Travis CI ä¸­å¦‚æœä½¿ç”¨ `root`ï¼Œå°±ä¼šç»™ä½ å»ºç«‹ä¸€ä¸ª `OpenVZ` çš„å®¹å™¨/è™šæ‹Ÿæœº
* è¿˜æœ‰ä¸€å †å¾ˆä¸é”™çš„åŠŸèƒ½
	* `ploop` ï¼ˆå¯¹å®¹å™¨è€Œè¨€æ›´æœ‰æ•ˆçš„å—è®¾å¤‡ï¼‰
	* checkpoint/restoreï¼Œçƒ­è¿ç§»
	* `venet`ï¼ˆæ›´æœ‰æ•ˆç‡çš„ vethï¼‰
* è¿˜åœ¨å¼€å‘å’Œç»´æŠ¤

## Jails / Zones

* è¿™æ˜¯ FreeBSD / Solaris ç‰¹æœ‰çš„
* ç›¸å¯¹äº `namespace` å’Œ `cgroups` è€Œè¨€ï¼Œæ˜¯æ›´ç²—ç²’åº¦çš„æ§åˆ¶
* é‡ç‚¹å¼ºè°ƒçš„æ˜¯**å®‰å…¨æ€§**
* å¾ˆé€‚åˆæ‰˜ç®¡ä¸»æœºæä¾›å•†
* å¯¹å¼€å‘è€…æ¥è¯´æ„ä¹‰ä¸å¤§
	* æ²¡æœ‰ç­‰åŒäº `docker run -it ubuntu` çš„ä¸œè¥¿
* [Illumos](https://wiki.illumos.org/display/illumos/illumos+Home) ï¼ˆOpenSolaris çš„ç¤¾åŒº forkï¼‰å¯ä»¥è¿è¡Œ Linux å¯æ‰§è¡Œæ–‡ä»¶
	* ç”¨ [Joyent Triton](https://www.joyent.com/blog/triton-docker-and-the-best-of-all-worlds)
* è€Œ Oracle çš„ Solaris åˆ™åªå¯ä»¥è¿è¡Œ Solaris å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸å¯ä»¥è¿è¡Œ Linux å¯æ‰§è¡Œæ–‡ä»¶

# å¦‚ä½•æ‰‹åŠ¨å»ºç«‹å®¹å™¨

*ä»…ä¸ºæ•™è‚²ç›®çš„ğŸ˜*

è¿™é‡Œä½¿ç”¨ `btrfs` æ¥è¿›è¡Œ CoW çš„å­˜å‚¨å±‚ç®¡ç†ï¼Œåˆ©ç”¨å…¶ subvolume å’Œ snapshot æœºåˆ¶ã€‚

å…ˆç¡®ä¿æŒ‚è½½ç‚¹éƒ½æ˜¯ `rprivate`ï¼Œå¦åˆ™å®¹å™¨å†…çš„æŒ‚è½½å¦‚æœæ±¡æŸ“äº†å®¿ä¸»çš„æŒ‚è½½å°±ä¹±å¥—äº†ã€‚

```bash
mount --make-rprivate /
```

ç„¶ååˆ›å»ºé•œåƒã€å®¹å™¨çš„ç›®å½•ï¼Œå¹¶ä¸”åˆ›å»º btrfs çš„ subvolumeï¼Œå¹¶ä¸”å¡«å……å…¥ alpine çš„é•œåƒå†…å®¹ã€‚

```bash
# åˆ›å»ºé•œåƒã€å®¹å™¨çš„ç›®å½•
$ mkdir -p images containers
# åˆ›å»º btrfs çš„ subvolume
$ btrfs subvol create images/alpine
Create subvolume 'images/alpine'
$ btrfs subvol list .
ID 257 gen 8 top level 5 path images/alpine
# å¡«å……å…¥ alpine çš„é•œåƒå†…å®¹ï¼Œè¿™é‡Œç›´æ¥å€Ÿç”¨ docker é•œåƒ rootfs
$ CID=$(docker run -d alpine true)
Unable to find image 'alpine:latest' locally
latest: Pulling from library/alpine
0a8490d0dfd3: Pulling fs layer
0a8490d0dfd3: Verifying Checksum
0a8490d0dfd3: Download complete
0a8490d0dfd3: Pull complete
Digest: sha256:dfbd4a3a8ebca874ebd2474f044a0b33600d4523d03b0df76e5c5986cb02d7e8
Status: Downloaded newer image for alpine:latest
$ echo $CID
434cf134e44ee47211fab5c2da31de2ec13a22d9ed2a3e3da2a9831d7585d71e
$ docker export $CID | tar -C images/alpine/ -xf-
$ ls images/alpine/
bin  etc   lib    mnt   root  sbin  sys  usr
dev  home  media  proc  run   srv   tmp  var
```

ä»¥é•œåƒ subvolume ä¸ºåŸºç¡€ï¼Œä½¿ç”¨ snapshot åˆ›å»ºå®¹å™¨ tupperwareã€‚

```bash
$ btrfs subvol snapshot images/alpine/ containers/tupperware
Create a snapshot of 'images/alpine/' in 'containers/tupperware'
$ ls containers/tupperware/
bin  etc   lib    mnt   root  sbin  sys  usr
dev  home  media  proc  run   srv   tmp  var
# ä¸ºäº†ç¡®ä¿å¯ä»¥è®¤å‡ºè¿™æ˜¯æˆ‘ä»¬çš„å®¹å™¨ï¼Œå»ºä¸€ä¸ªæ ‡å¿—æ–‡ä»¶
$ touch containers/tupperware/THIS_IS_TUPPERWAARE
```

æˆ‘ä»¬å¯ä»¥ç”¨ `chroot` è¿›å…¥æˆ‘ä»¬çš„rootfsï¼Œå¯ä»¥ç”¨ alpine çš„åŒ…ç®¡ç† apk äº†ã€‚å½“ç„¶ï¼Œæš‚æ—¶è¿˜ä¸èƒ½ç§°ä¸ºå®¹å™¨ã€‚

```bash
$ chroot containers/tupperware/ sh
$ ls
THIS_IS_TUPPERWAARE  media                srv
bin                  mnt                  sys
dev                  proc                 tmp
etc                  root                 usr
home                 run                  var
lib                  sbin
$ apk
apk-tools 2.6.8, compiled for x86_64.
...
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å¯ namespace äº†ï¼Œå¯ä»¥åˆ©ç”¨ `unshare` å‘½ä»¤ï¼š

```bash
$ unshare --mount --uts --ipc --net --pid --fork bash
```

è¿™ä¸ªå‘½ä»¤æ‰§è¡Œåï¼Œå®é™…ä¸Šå·²ç»è¿›å…¥å®¹å™¨äº†ï¼Œä½†æ˜¯æ„ŸçŸ¥ä¸åˆ°ï¼Œç‰¹åˆ«æ˜¯ ps çš„æ—¶å€™è§‚å¯Ÿå…¶ pidï¼Œè¿˜æ˜¯å®¿ä¸»çš„ pidã€‚

```bash
 $ ps
  PID TTY          TIME CMD
 1846 pts/0    00:00:00 sudo
 1847 pts/0    00:00:00 bash
 2386 pts/0    00:00:00 unshare
 2387 pts/0    00:00:00 bash
 2412 pts/0    00:00:00 ps
```

å…¶å®è¿™äº› `pid` å·²ç»æ— æ³•è®¿é—®åˆ°äº†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¯•å›¾ `kill` å…¶ä¸­çš„è¿›ç¨‹ï¼Œä¼šå¤±è´¥ï¼Œè¯´æ‰¾ä¸åˆ°è¯¥è¿›ç¨‹ï¼š

```bash
$ kill 2386
bash: kill: (2386) - No such process
```

å› æ­¤æˆ‘ä»¬éœ€è¦åšçš„æ˜¯é‡æ–°æŒ‚è½½ `/proc`ï¼Œç„¶å `ps` å°±çœŸçš„æ˜¾ç¤ºå®¹å™¨å†…çš„ä¿¡æ¯äº†ï¼š

```bash
$ mount -t proc none /proc
$ ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 03:43 pts/0    00:00:00 bash
root        28     1  0 03:45 pts/0    00:00:00 ps -ef
```

æ¥ä¸‹æ¥æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸œè¥¿ä¾æ—§è¿˜æ˜¯å®¿ä¸»ï¼Œæˆ‘ä»¬éœ€è¦åˆ‡æ¢åˆ° tuppwerware ä¸‹ï¼Œä¸è¿‡è¿™é‡Œ `pivot_root` ç›´æ¥æ°¸ä¼šæŠ¥é”™ï¼š

```bash
$ cd containers/tupperware
$ mkdir oldroot
$ pivot_root . oldroot/
pivot_root: failed to change root from `.' to `oldroot/': Invalid argument
```

è§£å†³åŠæ³•æ˜¯åˆ©ç”¨ bind-mountã€‚

```bash
$ cd /
$ mount --bind /mnt/data/containers/tupperware/ /mnt/data/containers/tupperware/
$ mount --move /mnt/data/containers/tupperware/ /btrfs
$ cd /btrfs/
$ ls
THIS_IS_TUPPERWAARE  dev  home  media  oldroot  root  sbin  sys  usr
bin                  etc  lib   mnt    proc     run   srv   tmp  var
$ pivot_root . oldroot/
$ cd /
$ ls -al
total 4
drwxr-xr-x    1 root     root           180 Jan 30 03:46 .
drwxr-xr-x    1 root     root           180 Jan 30 03:46 ..
-rwxr-xr-x    1 root     root             0 Jan 30 03:32 .dockerenv
-rw-r--r--    1 root     root             0 Jan 30 03:40 THIS_IS_TUPPERWAARE
drwxr-xr-x    1 root     root           808 Dec 26 21:32 bin
drwxr-xr-x    1 root     root            34 Jan 30 03:32 dev
drwxr-xr-x    1 root     root           524 Jan 30 03:32 etc
drwxr-xr-x    1 root     root             0 Dec 26 21:32 home
drwxr-xr-x    1 root     root           278 Dec 26 21:32 lib
drwxr-xr-x    1 root     root            28 Dec 26 21:32 media
drwxr-xr-x    1 root     root             0 Dec 26 21:32 mnt
drwxr-xr-x   26 root     root          4096 Jan 30 03:50 oldroot
drwxr-xr-x    1 root     root             0 Dec 26 21:32 proc
drwx------    1 root     root            24 Jan 30 03:41 root
drwxr-xr-x    1 root     root             0 Dec 26 21:32 run
drwxr-xr-x    1 root     root           778 Dec 26 21:32 sbin
drwxr-xr-x    1 root     root             0 Dec 26 21:32 srv
drwxr-xr-x    1 root     root             0 Dec 26 21:32 sys
drwxrwxrwt    1 root     root             0 Dec 26 21:32 tmp
drwxr-xr-x    1 root     root            40 Dec 26 21:32 usr
drwxr-xr-x    1 root     root            78 Dec 26 21:32 var
$ mount -t proc none /proc
$ ps -ef
PID   USER     TIME   COMMAND
    1 root       0:00 bash
   44 root       0:00 ps -ef
```

ç°åœ¨çœ‹èµ·æ¥å°±æ›´åƒåœ¨å®¹å™¨é‡Œäº†ï¼Œæœ‰äº†è‡ªå·±çš„ rootfsï¼Œæœ‰äº†è‡ªå·±çš„ pid ç©ºé—´ã€‚ä¸è¿‡ mount è¿˜æ˜¯å®¿ä¸»çš„ã€‚æˆ‘ä»¬éœ€è¦å¸æ‰ã€‚

```bash
$ umount -a
umount: can't unmount /oldroot/mnt/data: Resource busy
umount: can't unmount /oldroot: Resource busy
```

å¯ä»¥çœ‹åˆ°è¿™é‡Œ `/oldroot` ä¸è®©å¸è½½ï¼Œå› ä¸ºè®¾å¤‡å¿™ã€‚è¿™åˆæ˜¯ä¸€ä¸ªå°åœ°æ–¹éœ€è¦ç»•è¿‡çš„ã€‚

```bash
$ umount -l /oldroot/
$ mount -t proc none /proc
$ mount
/dev/dm-2 on / type btrfs (ro,relatime,space_cache,subvolid=258,subvol=/containers/tupperware)
none on /proc type proc (rw,relatime)
```

è¿™å›æŒ‚è½½å°±æ­£å¸¸äº†ï¼Œä»…å‰©å®¹å™¨çš„æŒ‚è½½äº†ã€‚

æ¥ä¸‹æ¥æ˜¯ç½‘ç»œï¼Œå¦‚æœè¿™æ—¶åœ¨å®¹å™¨å†…æƒ³è®¿é—®å¤–ç•Œç½‘ç»œï¼Œä¼šå‘ç°æ— æ³•å®ç°ï¼Œå…¶åŸå› æ˜¯å®¹å™¨å†…è¿˜æ²¡æœ‰è‡ªå·±çš„ç½‘ç»œæ¥å£å‘¢ã€‚

```bash
$ ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
$ ifconfig -a
lo        Link encap:Local Loopback
          LOOPBACK  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

```

æˆ‘ä»¬éœ€è¦**æ–°å¼€ä¸€ä¸ªç»ˆç«¯**ï¼Œåœ¨*å®¿ä¸»*æ‰§è¡Œå‘½ä»¤å»ºç«‹å®¹å™¨ç½‘ç»œæ¥å£ã€‚

```bash
# å…ˆæŸ¥åˆ°æˆ‘ä»¬å®¹å™¨çš„è¿›ç¨‹ ID
$ pidof unshare
2386

# ç„¶åæ·»åŠ ä¸€å¯¹ veth æ¥å£
$ ip link add name h2386 type veth peer name c2386
$ ip link
...
6: c2386@h2386: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 86:ce:e2:44:86:e5 brd ff:ff:ff:ff:ff:ff
7: h2386@c2386: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether c6:9e:00:0e:df:4d brd ff:ff:ff:ff:ff:ff
```

è¿™é‡Œæˆ‘ä»¬ç§°å®¿ä¸»çš„é‚£ç«¯å« `h2386`ï¼Œå®¹å™¨é‚£ç«¯å« `c2386`ã€‚

ç„¶åæˆ‘ä»¬å°†å®¹å™¨çš„é‚£ç«¯ç½®äºå®¹å™¨å‘½åç©ºé—´å†…ï¼Œè€Œå®¿ä¸»è¿™ç«¯è¿å…¥ `docker0` æ¡¥æ¥ç½‘ç»œã€‚

```bash
$ ip link set c2386 netns 2386
$ ip link set h2386 master docker0 up
```

*åˆ‡æ¢åˆ°å®¹å™¨å†…*ï¼Œæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°è¿å…¥è¿›æ¥çš„ç½‘ç»œæ¥å£äº†ï¼š

```bash
$ ifconfig -a
c2386     Link encap:Ethernet  HWaddr 86:CE:E2:44:86:E5
          BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

lo        Link encap:Local Loopback
          LOOPBACK  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
$ ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
6: c2386@if7: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN qlen 1000
    link/ether 86:ce:e2:44:86:e5 brd ff:ff:ff:ff:ff:ff
```

ç„¶åæˆ‘ä»¬å°†å®¹å™¨å†…çš„æ¥å£åç§°è®¾ä¸º `eth0`ï¼Œå¹¶ä¸”ç»™å®šåœ°å€å’Œç½‘å…³ã€‚

```bash
$ ip link set lo up
$ ip link set c2386 name eth0 up
$ ip addr add 172.17.10.123/16 dev eth0
$ ip route add default via 172.17.0.1
```

ç„¶åæˆ‘ä»¬çš„å®¹å™¨å°±å¯ä»¥ä¸Šç½‘äº†ï¼š

```bash
$ ip route
default via 172.17.0.1 dev eth0
172.17.0.0/16 dev eth0  src 172.17.10.123
$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: seq=0 ttl=61 time=6.956 ms
64 bytes from 8.8.8.8: seq=1 ttl=61 time=6.405 ms
^C
--- 8.8.8.8 ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 6.405/6.680/6.956 ms
```

*è§†é¢‘ä¸­åšåˆ°è¿™ä¸€æ­¥æ—¶ç”±äºç½‘å…³å†™é”™äº†ï¼Œå¯¼è‡´æœ€åä¸€æ­¥ç½‘ç»œæœªèƒ½è”é€šã€‚*

ç”±äºæ—¶é—´æœ‰é™ï¼Œè¿˜æœ‰å¤§é‡çš„ä¸»é¢˜åœ¨è¿™ä¸ªä¾‹å­ä¸­æ— æ³•æ¼”ç¤ºï¼Œæ¯”å¦‚ cgroupsã€devicesã€capabilities, selinux ç­‰ç­‰å¤§é‡çš„é—®é¢˜ã€‚

æ‰€ä»¥åœ¨æ¼”ç¤ºä¹‹å‰å°±æåˆ°ï¼Œ*ä»…ä¸ºæ•™è‚²ç›®çš„*ã€‚æˆ–è®¸æˆ‘ä»¬å¯ä»¥ç”¨è¿‡å‡ åè¡Œçš„ bash è„šæœ¬å°±å¯ä»¥åšä¸€ä¸ªè‡ªå·±çš„å®¹å™¨ï¼Œä½†æ˜¯**èƒ½è¿™ä¹ˆåšä¸ç­‰äºåº”è¯¥è¿™ä¹ˆåš**ã€‚
